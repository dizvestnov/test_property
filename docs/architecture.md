# Архитектура проекта PPA Phuket

## Обзор

Проект представляет собой Next.js 16 приложение для отображения каталога объектов недвижимости с возможностью переключения валют. Приложение использует App Router, серверные компоненты для SSR и клиентские компоненты для интерактивности.

## Технологический стек

- **Next.js 16** - React фреймворк с App Router
- **TypeScript** - типизированный JavaScript (strict mode)
- **Tailwind CSS** - утилитарный CSS фреймворк
- **Shadcn UI** - компоненты интерфейса на базе Radix UI
- **Bun** - пакетный менеджер и runtime
- **Lucide React** - библиотека иконок

## Структура проекта

**Важно**: Структура соответствует рекомендациям Next.js 16 App Router для масштабируемых проектов:
- `components/` на корневом уровне - общие переиспользуемые компоненты приложения
  - Компоненты приложения (Header, PropertyCard, CurrencySelect, PriceDisplay) - в корне `components/`
  - `components/ui/` - переиспользуемые UI компоненты библиотеки (Shadcn UI)
- `lib/` на корневом уровне - для общих утилит, используемых по всему приложению
- `data/` на корневом уровне - для статических данных и констант приложения
- `app/` - только для файлов роутинга (page.tsx, layout.tsx, error.tsx и т.д.)
- Разделение серверных (`lib/cookies.ts`) и клиентских (`lib/cookies-client.ts`) функций

**Масштабирование**: При росте проекта компоненты, специфичные для конкретных фич/роутов, можно размещать внутри `app/[feature]/components/` для colocation. Общие компоненты остаются в корневом `components/`.

```
PPA Phuket/
├── app/                          # App Router директория
│   ├── error.tsx                # Error Boundary (клиентский компонент)
│   ├── loading.tsx              # Loading UI (серверный компонент)
│   ├── not-found.tsx            # 404 страница (серверный компонент)
│   ├── layout.tsx               # Root layout с метаданными и шрифтами
│   ├── page.tsx                 # Главная страница со списком объектов
│   └── globals.css              # Глобальные стили и CSS переменные
├── components/                   # Переиспользуемые компоненты (корневой уровень)
│   ├── Header.tsx               # Серверный компонент header
│   ├── CurrencySelect.tsx       # Клиентский компонент выбора валюты
│   ├── PropertyCard.tsx          # Компонент карточки объекта
│   ├── PriceDisplay.tsx          # Компонент отображения цены
│   └── ui/                       # Shadcn UI компоненты (библиотека)
│       ├── button.tsx            # Компонент Button
│       ├── card.tsx              # Компонент Card
│       ├── select.tsx            # Компонент Select
│       └── skeleton.tsx           # Компонент Skeleton для loading states
├── lib/                          # Утилиты и вспомогательные функции (корневой уровень)
│   ├── currency.ts              # Работа с валютами и курсами
│   ├── cookies.ts               # Серверные функции работы с cookies
│   ├── cookies-client.ts        # Клиентские функции работы с cookies
│   └── utils.ts                 # Вспомогательные функции (cn)
├── data/                         # Данные приложения (корневой уровень)
│   └── properties.ts            # Захардкоженные данные объектов
├── public/                       # Статические файлы
├── package.json                  # Зависимости и скрипты
├── tsconfig.json                # Конфигурация TypeScript
├── tailwind.config.ts           # Конфигурация Tailwind CSS
├── next.config.js               # Конфигурация Next.js
├── Dockerfile                   # Docker конфигурация
├── docker-compose.yml          # Docker Compose конфигурация
└── README.md                    # Инструкция по запуску
```

## Соответствие Next.js 16 App Router

### Специальные файлы конвенций

#### `app/error.tsx`
- **Тип**: Клиентский компонент (`'use client'`)
- **Назначение**: Error Boundary для обработки ошибок
- **Функциональность**:
  - Перехватывает ошибки в дочерних компонентах
  - Отображает пользовательский интерфейс ошибки
  - Предоставляет кнопку для повторной попытки (`reset()`)
  - Логирует ошибки в консоль

#### `app/loading.tsx`
- **Тип**: Серверный компонент
- **Назначение**: Loading UI во время загрузки данных
- **Функциональность**:
  - Автоматически отображается при переходе между страницами
  - Показывает skeleton loader для карточек
  - Улучшает UX во время загрузки

#### `app/not-found.tsx`
- **Тип**: Серверный компонент
- **Назначение**: 404 страница для несуществующих маршрутов
- **Функциональность**:
  - Отображается при обращении к несуществующему маршруту
  - Предоставляет ссылку на главную страницу
  - Пользовательский интерфейс ошибки 404

## Архитектура компонентов

### Типы рендеринга

#### Dynamic SSR (Server-Side Rendering)
- **page.tsx**: Использует `async` функцию для получения cookies
- Рендерится на сервере при каждом запросе
- Поддерживает динамические данные (cookies)

#### Server Components (по умолчанию)
- Все компоненты без `'use client'` являются серверными
- Рендерятся на сервере
- Не имеют доступа к браузерным API
- Меньший размер бандла

#### Client Components
- Компоненты с директивой `'use client'`
- Рендерятся на клиенте
- Имеют доступ к браузерным API и хукам React
- Используются только когда необходимо

### Серверные компоненты (Server Components)

#### `app/layout.tsx`
- **Тип рендеринга**: Server Component (SSR)
- **Назначение**: Root layout приложения
- **Функциональность**:
  - Подключение шрифтов через `next/font/google` (Inter, Playfair Display)
  - Установка CSS переменных для шрифтов
  - Рендеринг Header и children
  - Метаданные страницы
- **Принципы**: KISS - простая структура, одна ответственность

#### `app/page.tsx`
- **Тип рендеринга**: Dynamic SSR (async функция)
- **Назначение**: Главная страница со списком объектов
- **Функциональность**:
  - Получение выбранной валюты из cookies (server-side)
  - Рендеринг заголовка и сетки карточек
  - Передача валюты в каждую карточку
- **Принципы**: 
  - SSR для поддержки cookies без мерцания
  - DRY - переиспользование компонентов PropertyCard

#### `app/components/Header.tsx`
- **Тип рендеринга**: Server Component (SSR, async)
- **Назначение**: Header с переключателем валюты
- **Функциональность**:
  - Получение текущей валюты из cookies (server-side)
  - Отображение логотипа и названия
  - Рендеринг CurrencySelect с начальным значением
  - Sticky позиционирование с backdrop blur
- **Принципы**: 
  - Single Responsibility - только header логика
  - SSR для получения cookies на сервере

### Клиентские компоненты (Client Components)

#### `app/components/CurrencySelect.tsx`
- **Тип рендеринга**: Client Component (`'use client'`)
- **Назначение**: Dropdown для выбора валюты
- **Функциональность**:
  - Отображение текущей валюты
  - Обработка изменения валюты
  - Сохранение выбора в cookies (client-side)
  - Обновление страницы через `router.refresh()` для SSR

**Ключевые особенности**:
- Использует `'use client'` директиву (необходимо для интерактивности)
- Сохраняет валюту в cookies через `setCurrencyCookie()`
- Вызывает `router.refresh()` для обновления серверных компонентов
- Использует `useRouter` hook (только в клиентских компонентах)
- **Принципы**: 
  - Single Responsibility - только выбор валюты
  - Минимальный клиентский код (только где необходимо)

#### `app/components/PropertyCard.tsx`
- **Тип рендеринга**: Server Component (SSR)
- **Назначение**: Карточка объекта недвижимости
- **Функциональность**:
  - Отображение изображения с градиентом
  - Показ города поверх изображения (MapPin)
  - Отображение названия (обрезается на 2 строки)
  - Показ характеристик (спальни, площадь)
  - Отображение цены в выбранной валюте

**Ключевые особенности**:
- Использует Next.js Image для оптимизации изображений
- Hover эффекты (scale, translate-y, shadow)
- Градиент поверх изображения для читаемости текста
- Flexbox layout для прижатия цены к низу
- `line-clamp-2` для обрезки длинных названий
- **Принципы**: 
  - DRY - переиспользуемый компонент
  - KISS - простая структура, понятная логика
  - Single Responsibility - только отображение карточки

#### `app/components/PriceDisplay.tsx`
- **Тип рендеринга**: Server Component (SSR)
- **Назначение**: Отображение цены с форматированием
- **Функциональность**:
  - Конвертация цены из THB в выбранную валюту
  - Форматирование с символом валюты
  - Поддержка кастомных классов
- **Принципы**: 
  - DRY - переиспользуемый компонент для отображения цены
  - Single Responsibility - только форматирование и отображение цены
  - Pure function - нет side effects, только преобразование данных

## Работа с данными

### `data/properties.ts`

Интерфейс Property:
```typescript
interface Property {
  id: string
  title: string
  price: number        // Цена в THB
  area: number         // Площадь в м²
  bedrooms: number     // Количество спален
  location: string     // Город/локация
  imageUrl: string     // URL изображения
}
```

### `lib/currency.ts`

**Функции**:
- `convertCurrency(priceInThb, targetCurrency)` - конвертация цены
- `formatPrice(price, currency)` - форматирование с символом валюты

**Константы**:
- `CURRENCY_RATES` - курсы валют (THB, USD, EUR, RUB)
- `CURRENCY_SYMBOLS` - символы валют

### `lib/cookies.ts` и `lib/cookies-client.ts`

**Разделение серверных и клиентских функций**:

- `cookies.ts` (server-side):
  - `getCurrencyFromCookies()` - получение валюты из cookies на сервере
  - Использует `next/headers` API

- `cookies-client.ts` (client-side):
  - `setCurrencyCookie()` - установка валюты в cookies на клиенте
  - Использует `document.cookie` API
  - Помечен директивой `'use client'`

## Работа с валютами

### Механизм сохранения валюты

1. **При загрузке страницы**:
   - Серверный компонент `Header` и `page.tsx` получают валюту из cookies через `getCurrencyFromCookies()`
   - Если cookie нет, используется дефолтное значение `THB`
   - Страница рендерится с правильной валютой на сервере

2. **При изменении валюты**:
   - Клиентский компонент `CurrencySelect` сохраняет выбор в cookies через `setCurrencyCookie()`
   - Вызывается `router.refresh()` для обновления серверных компонентов
   - Страница перерендеривается с новой валютой без полной перезагрузки

3. **SSR без мерцания**:
   - Так как сервер знает выбранную валюту из cookies, нет гидратации с дефолтным значением
   - Цены отображаются правильно с первого рендера

## Стилизация

### Цветовая схема

Определена в `app/globals.css` через CSS переменные:
- Теплая цветовая палитра (золотые оттенки для primary)
- Поддержка темной темы
- Использование HSL значений для гибкости

### Шрифты

- **Playfair Display** - для заголовков (display font)
- **Inter** - для основного текста (body font)
- Загружаются через `next/font/google` для оптимизации

### Tailwind CSS

Конфигурация в `tailwind.config.ts`:
- Кастомные цвета через CSS переменные
- Кастомные шрифты (display, body)
- Анимации (fade-in, accordion)
- Поддержка dark mode

### Компоненты карточек

**Структура карточки**:
```
Card (flex flex-col h-full)
├── Image Container (aspect-[4/3])
│   ├── Image (Next.js Image)
│   ├── Gradient Overlay
│   └── Location Badge (MapPin + текст)
└── CardContent (flex flex-col flex-1)
    ├── Title (line-clamp-2)
    └── Bottom Section (mt-auto)
        ├── Features (спальни, площадь)
        └── Price (с разделителем сверху)
```

**Ключевые стили**:
- `h-full flex flex-col` на Card - растягивание на всю высоту
- `flex-1 flex-col` на CardContent - занимает доступное пространство
- `mt-auto` на нижнем блоке - прижимает к низу
- `line-clamp-2` на заголовке - обрезка на 2 строки
- `aspect-[4/3]` на изображении - фиксированное соотношение сторон

## Оптимизация изображений

### Next.js Image

- Используется компонент `Image` из `next/image`
- Автоматическая оптимизация и lazy loading
- Responsive sizes для разных экранов
- Настроены разрешенные домены в `next.config.js`:
  - `images.unsplash.com`

## Docker конфигурация

### Dockerfile

Multi-stage build:
1. **deps** - установка зависимостей через bun
2. **builder** - сборка приложения
3. **runner** - production образ с минимальными зависимостями

Использует `oven/bun:latest` образ для всех стадий.

### docker-compose.yml

Простая конфигурация для запуска контейнера с портом 3000.

## Принципы проектирования

### SOLID принципы

1. **Single Responsibility Principle (SRP)**
   - Каждый компонент имеет одну ответственность
   - `PriceDisplay` - только отображение цены
   - `CurrencySelect` - только выбор валюты
   - `PropertyCard` - только отображение карточки
   - Разделение серверных и клиентских функций (cookies.ts / cookies-client.ts)

2. **Open/Closed Principle (OCP)**
   - Компоненты открыты для расширения через props
   - `PriceDisplay` принимает `className` для кастомизации
   - Типы валют легко расширяемы через enum

3. **Liskov Substitution Principle (LSP)**
   - Интерфейсы Property и Currency обеспечивают контракты
   - Компоненты работают с любыми данными, соответствующими интерфейсам

4. **Interface Segregation Principle (ISP)**
   - Узкие интерфейсы (PropertyCardProps, PriceDisplayProps)
   - Компоненты получают только необходимые props

5. **Dependency Inversion Principle (DIP)**
   - Компоненты зависят от абстракций (интерфейсы, типы)
   - Утилиты изолированы и переиспользуемы

### DRY (Don't Repeat Yourself)

- Переиспользование компонентов (`PropertyCard`, `PriceDisplay`)
- Общие утилиты (`currency.ts`, `utils.ts`)
- Единая логика форматирования цен
- Общие стили через Tailwind классы

### KISS (Keep It Simple, Stupid)

- Простая структура проекта
- Минимум абстракций
- Понятная иерархия компонентов
- Прямолинейная логика без излишней сложности

## Особенности реализации

### SSR без мерцания

- Использование cookies вместо localStorage для SSR
- Серверные компоненты получают валюту на этапе рендеринга
- Нет гидратации с дефолтным значением
- Dynamic SSR для поддержки cookies

### Типобезопасность

- Строгая типизация TypeScript (`strict: true`)
- Типы для валют (`Currency`)
- Интерфейсы для данных (`Property`)
- Типизированные props для всех компонентов

### Производительность

- Серверные компоненты по умолчанию (меньший бандл)
- Клиентские компоненты только где необходимо (интерактивность)
- Оптимизация изображений через Next.js Image
- Lazy loading изображений
- Loading states для улучшения UX

### Доступность

- Семантическая HTML разметка
- Alt текст для изображений
- Правильная структура заголовков
- Error boundaries для обработки ошибок
- 404 страница для несуществующих маршрутов

## Потоки данных

### Загрузка страницы

```
1. Browser Request
   ↓
2. Next.js Server
   ├── Header получает валюту из cookies
   ├── page.tsx получает валюту из cookies
   └── Рендеринг с правильной валютой
   ↓
3. HTML Response (с правильными ценами)
   ↓
4. Hydration (только клиентские компоненты)
```

### Изменение валюты

```
1. User выбирает валюту в CurrencySelect
   ↓
2. setCurrencyCookie() сохраняет в cookies
   ↓
3. router.refresh() обновляет серверные компоненты
   ↓
4. Серверные компоненты получают новую валюту из cookies
   ↓
5. Перерендер с новыми ценами (без полной перезагрузки)
```

## Зависимости

### Основные
- `next@16` - Next.js фреймворк
- `react@18` - React библиотека
- `react-dom@18` - React DOM

### UI компоненты
- `@radix-ui/react-select` - Select компонент
- `@radix-ui/react-slot` - Slot компонент для Button
- `lucide-react` - Иконки
- `tailwindcss-animate` - Анимации для Tailwind

### Утилиты
- `class-variance-authority` - Управление классами
- `clsx` - Условные классы
- `tailwind-merge` - Слияние Tailwind классов

## Конфигурационные файлы

### `next.config.js`
- `output: 'standalone'` - для Docker
- `images.remotePatterns` - разрешенные домены для изображений

### `tsconfig.json`
- `strict: true` - строгий режим TypeScript
- `paths` - алиасы для импортов (`@/*`)

### `tailwind.config.ts`
- Кастомные цвета, шрифты, анимации
- Поддержка dark mode
- Плагин `tailwindcss-animate`

## Команды запуска

### Разработка
```bash
bun install && bun dev
```

### Production
```bash
bun run build && bun run start
```

### Docker
```bash
docker-compose up
```

## Будущие улучшения

1. Добавление фильтров по цене, площади, количеству спален
2. Пагинация или бесконечная прокрутка
3. Детальная страница объекта
4. Поиск по названию/локации
5. Сортировка объектов
6. Интеграция с реальным API вместо захардкоженных данных
